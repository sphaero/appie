#!/usr/bin/python3
# 
# Copyright (c) 2015, Arnaud Loonstra, All rights reserved.
# 
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public
# License as published by the Free Software Foundation; either
# version 3.0 of the License, or (at your option) any later version.
# 
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License v3 for more details.
# 
# You should have received a copy of the GNU Lesser General Public
# License along with this library.

import argparse
import appie
import logging
import sys
import importlib

def str_to_class(class_path):
    module_name, class_name = class_path.rsplit('.', 1)
    try:
        module_ = importlib.import_module(module_name)
        try:
            class_ = getattr(module_, class_name)()
        except AttributeError:
            logging.error('Class does not exist')
            sys.exit(1)
    except ImportError:
        logging.error('Module does not exist')
        sys.exit(1)
    return class_


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Appie Static HTML generator for dynamic websites')
    parser.add_argument('-s','--source', help='root directory with source files', required=True)
    parser.add_argument('-t','--target', help='path to where the files will be generated', default="./build", required=False)
    parser.add_argument('-w','--www', help='after generating serve the files through a http server ', default=False, required=False, action='store_true')
    parser.add_argument('-p','--port', help='port for the http server', default=8000, type=int, required=False)
    parser.add_argument('-f','--file-ext', nargs='*', help="file parser extensions to add to appie (LIFO order)", default=[])
    parser.add_argument('-d','--dir-ext', nargs='*', help="directory parser extensions to add to appie (LIFO order)", default=[])
    parser.add_argument('-v','--verbose', help="verbose output", default=False, required=False, action='store_true')
    args = vars(parser.parse_args())
    #print(args.get('file_ext'), args)
    #sys.exit(0)
    appie.config['src'] = args.get('source')
    appie.config['target'] = args.get('target')
    appie.config['verbose'] = args.get('verbose')
    if appie.config['verbose']:
        logging.basicConfig(level=logging.DEBUG)
    a = appie.Appie()
    for p in args.get('file_ext', []):
        instance = str_to_class(p)
        a.add_file_parser(instance)
    for p in args.get('dir_ext', []):
        instance = str_to_class(p)
        a.add_directory_parser(instance)

    a.parse()
    
    # serve files if requested
    if args.get('www'):
        from wsgiref.simple_server import make_server
        from webob import static        
        httpd = make_server('', 
                        args.get('port'), 
                        static.DirectoryApp(args.get('target'))
                        )
        print("Serving on port 8000...     press CTRL-C to quit")
        # Serve until process is killed
        try:
            httpd.serve_forever()
        except (KeyboardInterrupt, SystemExit):
            print("\n")
